{% extends 'task/layout.html' %}
{% load static %}

{% block body %}
<div class="container mt-5">
    <h1>üîç React Diagnostic Page</h1>
    
    <div class="card mt-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">System Check</h5>
        </div>
        <div class="card-body">
            <div id="diagnostic-results"></div>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">API Test</h5>
        </div>
        <div class="card-body">
            <button class="btn btn-primary" onclick="testAPI()">Test API Connection</button>
            <div id="api-results" class="mt-3"></div>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">React Test Area</h5>
        </div>
        <div class="card-body">
            <div id="react-test-root"></div>
        </div>
    </div>
</div>

<script type="text/babel">
    // Diagnostic au chargement
    document.addEventListener('DOMContentLoaded', function() {
        const results = document.getElementById('diagnostic-results');
        let html = '<ul class="list-group">';
        
        // Test React
        html += `<li class="list-group-item ${typeof React !== 'undefined' ? 'list-group-item-success' : 'list-group-item-danger'}">
            <strong>React:</strong> ${typeof React !== 'undefined' ? '‚úÖ Loaded (v' + React.version + ')' : '‚ùå Not loaded'}
        </li>`;
        
        // Test ReactDOM
        html += `<li class="list-group-item ${typeof ReactDOM !== 'undefined' ? 'list-group-item-success' : 'list-group-item-danger'}">
            <strong>ReactDOM:</strong> ${typeof ReactDOM !== 'undefined' ? '‚úÖ Loaded' : '‚ùå Not loaded'}
        </li>`;
        
        // Test CSRF
        html += `<li class="list-group-item ${typeof getCSRFToken !== 'undefined' ? 'list-group-item-success' : 'list-group-item-danger'}">
            <strong>getCSRFToken:</strong> ${typeof getCSRFToken !== 'undefined' ? '‚úÖ Available' : '‚ùå Not available'}
        </li>`;
        
        // Test CSRF Token
        const token = typeof getCSRFToken !== 'undefined' ? getCSRFToken() : null;
        html += `<li class="list-group-item ${token ? 'list-group-item-success' : 'list-group-item-warning'}">
            <strong>CSRF Token:</strong> ${token ? '‚úÖ Found: ' + token.substring(0, 20) + '...' : '‚ö†Ô∏è Not found'}
        </li>`;
        
        // Test TaskList
        html += `<li class="list-group-item ${typeof TaskList !== 'undefined' ? 'list-group-item-success' : 'list-group-item-danger'}">
            <strong>TaskList Component:</strong> ${typeof TaskList !== 'undefined' ? '‚úÖ Loaded' : '‚ùå Not loaded'}
        </li>`;
        
        // Test TaskCard
        html += `<li class="list-group-item ${typeof TaskCard !== 'undefined' ? 'list-group-item-success' : 'list-group-item-danger'}">
            <strong>TaskCard Component:</strong> ${typeof TaskCard !== 'undefined' ? '‚úÖ Loaded' : '‚ùå Not loaded'}
        </li>`;
        
        html += '</ul>';
        results.innerHTML = html;
        
        // Test React simple
        if (typeof React !== 'undefined' && typeof ReactDOM !== 'undefined') {
            const TestComponent = () => {
                return React.createElement('div', { className: 'alert alert-success' },
                    '‚úÖ React is working! This component was rendered successfully.'
                );
            };
            
            ReactDOM.render(
                React.createElement(TestComponent),
                document.getElementById('react-test-root')
            );
        }
    });
    
    // Test API
    async function testAPI() {
        const resultsDiv = document.getElementById('api-results');
        resultsDiv.innerHTML = '<div class="spinner-border text-primary" role="status"></div> Testing...';
        
        try {
            const response = await fetch('/api/tasks/');
            const data = await response.json();
            
            resultsDiv.innerHTML = `
                <div class="alert alert-success">
                    <h5>‚úÖ API Connection Successful</h5>
                    <p><strong>Status:</strong> ${response.status}</p>
                    <p><strong>Tasks found:</strong> ${data.tasks ? data.tasks.length : 0}</p>
                    <details>
                        <summary>View Raw Response</summary>
                        <pre class="mt-2">${JSON.stringify(data, null, 2)}</pre>
                    </details>
                </div>
            `;
        } catch (error) {
            resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h5>‚ùå API Connection Failed</h5>
                    <p>${error.message}</p>
                </div>
            `;
        }
    }
</script>
{% endblock %}